# ATOM Lite 1 ボタン選択システム（サーバー制御機能付き）

このプロジェクトは、M5Stack ATOM Lite を使用して、1 つのボタンで複数の選択肢（2〜4 択）を操作できるシステムを実装します。さらに、サーバーからの設定に基づいて選択肢の数を動的に変更し、特定の条件下（例：授業外）では操作を無効化する機能を備えています。

## 目次

1.  [機能概要](#機能概要)
2.  [システム構成](#システム構成)
3.  [ATOM Lite (クライアント) 側の実装](#atom-lite-クライアント-側の実装)
    - [必要なライブラリ](#必要なライブラリ)
    - [Arduino IDE セットアップ](#arduino-ide-セットアップ)
    - [スケッチ (`atom_lite_selector.ino`)](#スケッチ-atom_lite_selectorino)
    - [コードのカスタマイズポイント](#コードのカスタマイズポイント)
    - [動作の流れ](#動作の流れ)
4.  [サーバー側の要件](#サーバー側の要件)
5.  [使用方法](#使用方法)

---

### 機能概要

- **1 ボタン多選択肢:** ATOM Lite の 1 つのボタンと RGB LED を使い、2〜4 つの選択肢から 1 つを選び、確定する操作を実現します。
- **「選択 → 確定」方式:** ボタンの短押しで選択肢（LED の色）を順次切り替え、長押しで現在表示されている選択肢を確定します。
- **サーバーによる制御:** サーバーから現在の最大選択肢数 (`max_n`) をポーリングで取得し、ATOM Lite の操作範囲を動的に変更します。
- **操作の無効化:** `max_n=0` の場合、ATOM Lite のボタン操作を無効化し、特定の LED 表示で「操作不可」の状態を示します（例：先生が授業を投影していない時）。
- **視覚的フィードバック:** RGB LED の色変化、点滅パターンにより、現在の選択肢、確定、エラー、操作不可の状態をユーザーに伝えます。

### システム構成

```
+----------------+          +-------------------+          +-----------------+
| ATOM Lite      |          | Wi-Fi Network     |          | サーバー        |
| - 1 Button     |<-------->| (SSID/Password)   |<-------->| - /get_max_n    |
| - RGB LED      | Wi-Fi    |                   | HTTP GET |   (JSON応答)    |
| - ESP32        |          |                   |          |                 |
+----------------+          +-------------------+          +-----------------+
        ^                            ^
        |ポーリング間隔(例: 10秒)    |
        |                            |
        +----------------------------+
         サーバーから max_n を取得
```

### ATOM Lite (クライアント) 側の実装

#### 必要なライブラリ

Arduino IDE のライブラリマネージャから以下のライブラリをインストールしてください。

- **`FastLED`** by Daniel Garcia (ATOM Lite の RGB LED 制御用)
- **`Button2`** by Lennart Hennigs (ボタンのイベントハンドリングを容易にするため、チャタリング対策も含む)

また、ESP32 ボードをサポートするために、Arduino IDE のボードマネージャから **`esp32 by Espressif Systems`** をインストールしてください。

#### Arduino IDE セットアップ

1.  **Arduino IDE のインストール:** 公式サイトからダウンロードしてインストールします。
2.  **ESP32 ボードの追加:**
    - 「ファイル」->「環境設定」を開きます。
    - 「追加のボードマネージャの URL」に `https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json` を追加します。
    - 「ツール」->「ボード」->「ボードマネージャ」を開き、`ESP32` を検索してインストールします。
3.  **ボードの選択:** 「ツール」->「ボード」->「M5Stack Arduino」-> `M5Stack-ATOM` を選択します。
4.  **ライブラリのインストール:** 「スケッチ」->「ライブラリをインクルード」->「ライブラリを管理」から上記「必要なライブラリ」を検索してインストールします。
5.  **ポートの選択:** ATOM Lite を USB-C ケーブルで PC に接続し、「ツール」->「ポート」から該当する COM ポートを選択します。

#### スケッチ (`atom_lite_selector.ino`)

大きなコードのため、[atom_lite_selector.ino](#atom_lite_selectorino) を参照してください。

#### コードのカスタマイズポイント

- **Wi-Fi 設定:**
  ```cpp
  const char* ssid = "YOUR_WIFI_SSID";
  const char* password = "YOUR_WIFI_PASSWORD";
  ```
  ご自身の Wi-Fi の SSID とパスワードに置き換えてください。
- **サーバー URL:**
  ```cpp
  const char* serverUrl = "http://YOUR_SERVER_IP_OR_DOMAIN/get_max_n";
  ```
  `get_max_n` エンドポイントを持つサーバーの IP アドレスまたはドメイン名に置き換えてください。
- **選択肢の色:**
  ```cpp
  const CRGB ALL_CHOICES[] = {
    CRGB::Red,     // 選択肢1
    CRGB::Green,   // 選択肢2
    CRGB::Blue,    // 選択肢3
    CRGB::Yellow,  // 選択肢4
    // 必要に応じて色を追加/変更
  };
  ```
  資料や用途に合わせて、各選択肢の色を自由に変更・追加してください。`CRGB::Red`, `CRGB::Green`, `CRGB::Blue`, `CRGB::Yellow`, `CRGB::Purple`, `CRGB::Cyan`, `CRGB::Orange`, `CRGB::White` など、`FastLED` で利用可能な多くの色があります。
- **LED の明るさ:**
  ```cpp
  FastLED.setBrightness(30);
  ```
  `0` から `255` の間で調整可能です。環境に合わせて適切な明るさに設定してください。
- **ポーリング間隔:**
  ```cpp
  const unsigned long POLLING_INTERVAL = 10000; // 10秒
  ```
  サーバーへの問い合わせ頻度を調整します。リアルタイム性の要件とサーバーの負荷に応じて設定してください。
- **確定後のアクション:**
  ```cpp
  // ここで、確定した選択肢（currentChoiceIndex）に対応するアクションを実行します
  // 例: if (currentChoiceIndex == 0) { /* アクション1 (選択肢1) */ }
  //     else if (currentChoiceIndex == 1) { /* アクション2 (選択肢2) */ }
  //     ...
  ```
  `button_longclick` 関数内で、確定された選択肢に応じて実行したい具体的な処理（例：別のサーバーエンドポイントへの Webhook 送信、M5Stack であれば画面表示の切り替えなど）を記述してください。

#### 動作の流れ

1.  **起動:** ATOM Lite が起動し、Wi-Fi に接続を試みます（青い点滅）。
2.  **`max_n` 取得:** Wi-Fi 接続後、設定されたポーリング間隔でサーバーに `max_n` の値を問い合わせます。
3.  **初期状態:**
    - `max_n=0` の場合（授業外など）：LED がゆっくりと薄い白で点滅し、ボタンは無効になります。
    - `max_n > 0` の場合（授業中など）：LED は消灯し、ボタン操作を受け付ける準備ができます。
4.  **選択肢の切り替え:**
    - `max_n > 0` の時、ボタンを**短押し**するたびに、LED の色が `ALL_CHOICES` 配列の中から `max_n` の範囲で順番に切り替わります（例：`max_n=3` なら赤 → 緑 → 青 → 赤…）。
    - `max_n=0` の時は、短押ししても LED は変わらず、何も起こりません。
5.  **選択の確定:**
    - 目的の選択肢の色が表示されているときに、ボタンを約 1 秒間**長押し**します。
    - 確定されると、その選択肢の色で LED が約 2 秒間点滅し、対応するアクションが実行されます。
6.  **状態リセット:** 確定後の点滅が終了するか、`max_n` の値がサーバーから更新されると、システムは初期状態に戻り、次の操作を待ちます。
7.  **エラー表示:** Wi-Fi 接続失敗、HTTP リクエストエラー、JSON パースエラーなどが発生した場合は、LED が赤く点滅してユーザーに異常を知らせます。

---

### サーバー側の要件

ATOM Lite からの HTTP GET リクエスト (`YOUR_SERVER_IP_OR_DOMAIN/get_max_n`) に対して、現在の最大選択肢数 (`max_n`) を JSON 形式で返却するシンプルなエンドポイントが必要です。

**サーバーからの JSON レスポンス例:**

- **授業中（4 択の場合）:**
  ```json
  { "max_n": 4 }
  ```
- **授業外（操作不可の場合）:**
  ```json
  { "max_n": 0 }
  ```
- **2 択の場合:**
  ```json
  { "max_n": 2 }
  ```

**注意点:**

- サーバーは、ATOM Lite からアクセス可能なネットワーク内に配置されている必要があります。
- `max_n` の値は `0` から `ALL_CHOICES` 配列の要素数までの範囲で設定してください。

---

### 使用方法

1.  上記の `atom_lite_selector.ino` スケッチをコピーし、Arduino IDE に貼り付けます。
2.  **`ssid`**, **`password`**, **`serverUrl`** をあなたの環境に合わせて変更します。
3.  必要に応じて **`ALL_CHOICES`** の色配列や **`FastLED.setBrightness`** を調整します。
4.  ATOM Lite を PC に接続し、ボードとポートが正しく選択されていることを確認します。
5.  スケッチをコンパイルし、ATOM Lite に書き込みます。
6.  サーバー側で `get_max_n` エンドポイントを用意し、適切に `max_n` を返すように設定します。
7.  ATOM Lite の動作を確認します。ボタンの短押しと長押し、そしてサーバーから `max_n` を `0` や `2`, `4` などに切り替えた際の動作変化を観察してください。

---
